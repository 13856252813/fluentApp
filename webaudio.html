<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    html,body{
        width: 100%;
        height: 100%;
    }
    input{
        position: absolute;
        left: 0px;
        top: 0px;
    }
    .wave-box{
        width: 100%;
        height: 50vh;
        position: absolute;
        left: 0px;
        bottom: 0px;
    }
    canvas{
        width: calc(100% + 40px);
        height: 100%;
        margin-left: -40px;
    }
</style>
<body>
<input type="file" id="file">
<div class="wave-box" id="waveBox">
    <canvas id="waveCanvas"></canvas>
</div>
</body>
<script>
    var audioContext=new window.AudioContext();
    var file = document.getElementById('file');
    file.onchange = function (e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = function (e) {
            var fileRes = e.target.result;
            audioContext.decodeAudioData(fileRes, function (buffer) {
                var audioBufferSouceNode = audioContext.createBufferSource();
                var analyser = audioContext.createAnalyser();
                audioBufferSouceNode.connect(analyser);
                analyser.connect(audioContext.destination);
                audioBufferSouceNode.buffer = buffer;
                audioBufferSouceNode.start(0);
                var time = 0;
                function con() {
                    if(time == 0) {
                        var array = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(array);
                        var ave = averger(array);
                        xx = Math.floor(Math.random() * 250);
                        autoDiff = 800 + ave * 2;
                        diffPt[xx] = autoDiff;
                        time = 10;
                        setTimeout(() => {
                            time = 0;
                        }, 1000)
                    }
                    update();
                    requestAnimationFrame(con);
                }
                requestAnimationFrame(con)
            })
        }
    };

    let canvas, ctx;
    let vertexes = [];
    let diffPt = [];
    let autoDiff = 0;
    let verNum = 250;
    let canvasW = window.innerWidth + 40;
    
    function averger(arr) {
        return arr.reduce((pre, cur) => {
            return pre + cur;
        }, 0) / arr.length
    }

    //初始化
    function init() {
        canvasW = document.getElementById('waveBox').offsetWidth + 40;
        initCanvas(canvasW, document.getElementById('waveBox').offsetHeight);
        let cW = canvas.width;
        let cH = canvas.height;
        for (let i = 0; i < verNum; i++)
            vertexes[i] = new Vertex(cW / (verNum - 1) * i, cH / 8, cH / 8);
        initDiffPt();
        let FPS = 30;
        let interval = 1000 / FPS >> 0;
        update()
        // let timer = setInterval(update, interval);
        // let timer2 = setInterval(() => {
        //     xx = Math.floor(Math.random() * 250);
        //     autoDiff = (Math.random() + 1) * 1000;
        //     diffPt[xx] = autoDiff;
        // }, 1000);

    }

    function initDiffPt() {
        for (let i = 0; i < verNum; i++)
            diffPt[i] = 0;
    }

    let xx = 0;
    let dd = 15;

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        autoDiff -= autoDiff * 0.9;
        diffPt[xx] = autoDiff;

        //左侧
        //差分，使得每个点都是上一个点的下一次的解，由于差分函数出来的解是一个曲线，且每次迭代后，曲线相加的结果形成了不断地波浪
        for (let i = xx - 1; i > 0; i--) {
            let d = xx - i;
            if (d > dd) d = dd;
            diffPt[i] -= (diffPt[i] - diffPt[i + 1]) * (1 - 0.01 * d);

        }
        //右侧
        for (let i = xx + 1; i < verNum; i++) {
            let d = i - xx;
            if (d > dd) d = dd;
            diffPt[i] -= (diffPt[i] - diffPt[i - 1]) * (1 - 0.01 * d);
        }

        //更新点Y坐标
        for (let i = 0; i < vertexes.length; i++) {
            vertexes[i].updateY(diffPt[i]);
        }

        draw();

    }

    let color1 = "rgba(240,143,143, 0.6)";
    let color2 = "rgba(240,143,143,0.8)";

    function draw() {
        ctx.beginPath();
        ctx.moveTo(0, document.getElementById('waveBox').offsetHeight);
        ctx.fillStyle = color1;
        ctx.lineTo(vertexes[0].x, vertexes[0].y);
        for (let i = 1; i < vertexes.length; i++) {
            ctx.lineTo(vertexes[i].x, vertexes[i].y);
        }
        ctx.lineTo(canvas.width, document.getElementById('waveBox').offsetHeight);
        ctx.lineTo(0, document.getElementById('waveBox').offsetHeight);
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(0, document.getElementById('waveBox').offsetHeight);
        ctx.fillStyle = color2;
        ctx.lineTo(vertexes[0].x + 15, vertexes[0].y + 5);
        for (let i = 1; i < vertexes.length; i++) {
            ctx.lineTo(vertexes[i].x + 15, vertexes[i].y + 5);
        }
        ctx.lineTo(canvas.width, document.getElementById('waveBox').offsetHeight);
        ctx.lineTo(0, document.getElementById('waveBox').offsetHeight);
        ctx.fill();
    }

    function initCanvas(width, height) {
        canvas = document.getElementById("waveCanvas");
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext("2d");
    }

    function Vertex(x, y, baseY) {
        this.baseY = baseY;
        this.x = x;
        this.y = y;
        this.vy = 0;
        this.targetY = 0;
        this.friction = 0.15;
        this.deceleration = 0.95;
    }

    Vertex.prototype.updateY = function (diffVal) {
        this.targetY = diffVal + this.baseY;
        this.vy += this.targetY - this.y;
        this.y += this.vy * this.friction;
        this.vy *= this.deceleration;
    };
    init();

</script>
</html>